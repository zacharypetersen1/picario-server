<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>PICO-8 Cartridge</title>
        <meta name="description" content="">

<STYLE TYPE="text/css">
<!--

canvas#canvas { width: 512px; height: 512px; }

.pico8_el {
	float:left;
	width:92px;
	display:inline-block; 
  	margin: 1px;
	padding: 4px;
	text-align: center;
	color:#fff;
	background-color:#777;
	font-family : verdana;
	font-size: 9pt;
	cursor: pointer;
	cursor: hand;
}
.pico8_el a{
	text-decoration: none;
	color:#fff;
}

.pico8_el:hover{
	background-color:#aaa;
}

.pico8_el:link{
	background-color:#aaa;
}

canvas{
    image-rendering: optimizeSpeed;
    image-rendering: -moz-crisp-edges;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: optimize-contrast;
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor;
    border: 0px
}

-->
</STYLE>
    
</head>

<body bgcolor=#303030>

	<br><br><br>

	<center><div style="width:512px;">

	<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>

	<script type="text/javascript">
		var canvas = document.getElementById("canvas");
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;

		// show Emscripten environment where the canvas is
		// arguments are passed to PICO-8
		
		var Module = {};
		Module.canvas = canvas;
		
		/*
			// When pico8_buttons is defined, PICO-8 takes each int to be a live bitfield
			// representing the state of each player's buttons
			
			var pico8_buttons = [0, 0, 0, 0, 0, 0, 0, 0]; // max 8 players
			pico8_buttons[0] = 2 | 16; // example: player 0, RIGHT and Z held down
			
			// when pico8_gpio is defined, reading and writing to gpio pins will
			// read and write to these values
			var pico8_gpio = new Array(128);
		*/
		var pico8_gpio = new Array(128);
		
		window.setTimeout(init, 5000);
		
		function init() {
			websocket = new WebSocket("ws://picariogame.com/ws");
			websocket.onopen = function(evt) { onOpen(evt) };
			websocket.onclose = function(evt) { onClose(evt) };
			websocket.onmessage = function(evt) { onMessage(evt) };
			websocket.onerror = function(evt) { onError(evt) };
		}
				
		function onOpen(evt)
		{
			//console.log("connected\n");
		}

		function onClose(evt)
		{
			//console.log("disconnected\n");
		}

		function onMessage(evt)
		{
			var str = evt.data;
			if(str[0] == 'Y') {
				pico8_gpio[0] = parseInt(str.substring(1));
			}
			var parts = str.split("|");
			if(parts.length == 4) {
				var obj = new Object();
				obj.id = parseInt(parts[0]);
				obj.x = parseInt(parts[1]);
				obj.y = parseInt(parts[2]);
				obj.size = parseInt(parts[3]);
				QueueSendToPico8(obj);
			}
			//console.log("response: " + evt.data + '\n');
		}

		function onError(evt)
		{
			//console.log('error: ' + evt.data + '\n');
			websocket.close();
		}
		
		window.setInterval(update, 10);
		
		function update() {
			ReadPico8();
			if(NeedSendPico8()) {
				WritePico8();
			}
		}
		
		// Begin PICO8 IO Code
		const PICO_PAYLOAD_SIZE = 6;
		
		const PICO_OUTBOUND_WE = 4;
		const PICO_OUTBOUND_NUM_PAYLOAD = 5;
		const PICO_OUTBOUND_PAYLOAD = 6;
		const PICO_OUTBOUND_MAX_PAYLOAD = 5;
		
		const PICO_INBOUND_WE = PICO_OUTBOUND_PAYLOAD + PICO_OUTBOUND_MAX_PAYLOAD * PICO_PAYLOAD_SIZE
		const PICO_INBOUND_NUM_PAYLOAD = PICO_INBOUND_WE + 1;
		const PICO_INBOUND_PAYLOAD = PICO_INBOUND_WE + 2;
		const PICO_INBOUND_MAX_PAYLOAD = 15;
		
		var pico8_inbound_queue = [];
		var pico8_inbound_send = [];
		var pico8_inbound_offset = 0;
		
		function QueueSendToPico8(obj) {
			pico8_inbound_queue.push(obj);
		}
		
		function NeedSendPico8() {
			return pico8_inbound_queue.length > 0;
		}
		
		function WritePico8() {
			if(pico8_gpio[PICO_INBOUND_WE] == 0){
				//console.log("Waiting to send");
				return;
			}
			while(pico8_inbound_send.length < PICO_INBOUND_MAX_PAYLOAD && pico8_inbound_queue.length > 0) {
				var obj = pico8_inbound_queue.shift();
				pico8_inbound_send.push(obj);
			}
			pico8_gpio[PICO_INBOUND_NUM_PAYLOAD] = pico8_inbound_send.length;
			pico8_inbound_offset = 0;
			while(pico8_inbound_send.length > 0) {
				var obj = pico8_inbound_send.shift();
				WriteToPico8(obj);
			}
			pico8_gpio[PICO_INBOUND_WE] = 0;
		}
		
		function WriteToPico8(obj) {
			InboundWrite(obj.id);
			InboundWrite(Math.floor(obj.x/256));
			InboundWrite(obj.x%256);
			InboundWrite(Math.floor(obj.y/256));
			InboundWrite(obj.y%256);
			InboundWrite(obj.size);
		}
		
		function InboundWrite(b) {
			pico8_gpio[PICO_INBOUND_PAYLOAD + pico8_inbound_offset] = b;
			pico8_inbound_offset++;
		}
		
		function ReadPico8() {
			if(pico8_gpio[PICO_OUTBOUND_WE] == 1) {
				//console.log("Waiting to read");
				return;
			}
			var num = pico8_gpio[PICO_OUTBOUND_NUM_PAYLOAD];
			for(var i = 0; i < num; i++) {
				var obj = new Object();
				obj.id = pico8_gpio[PICO_OUTBOUND_PAYLOAD + i * PICO_PAYLOAD_SIZE + 0];
				obj.x = pico8_gpio[PICO_OUTBOUND_PAYLOAD + i * PICO_PAYLOAD_SIZE + 1] * 256 + pico8_gpio[PICO_OUTBOUND_PAYLOAD + i * PICO_PAYLOAD_SIZE + 2];
				obj.y = pico8_gpio[PICO_OUTBOUND_PAYLOAD + i * PICO_PAYLOAD_SIZE + 3] * 256 + pico8_gpio[PICO_OUTBOUND_PAYLOAD + i * PICO_PAYLOAD_SIZE + 4];
				obj.size = pico8_gpio[PICO_OUTBOUND_PAYLOAD + i * PICO_PAYLOAD_SIZE + 5];
				websocket.send(obj.id + "|" + obj.x + "|" + obj.y + "|" + obj.size);
				//console.log(obj);
			}
			pico8_gpio[PICO_OUTBOUND_WE] = 1;
		}
		
		// End PICO8 IO Code
	</script>

	<script async type="text/javascript" src="picario.js"></script>
	  
	<script>
		// key blocker. prevent cursor keys from scrolling page while playing cart.
		
		function onKeyDown_blocker(event) {
			event = event || window.event;
			var o = document.activeElement;
			if (!o || o == document.body || o.tagName == "canvas")
			{
				if ([32, 37, 38, 39, 40].indexOf(event.keyCode) > -1)
				{
					if (event.preventDefault) event.preventDefault();
				}
			}
		}

		document.addEventListener('keydown', onKeyDown_blocker, false);

	</script>
        
	<br>

	<div class=pico8_el onclick="Module.pico8Reset();">

	<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAaklEQVR4Ae2dOwoAMQhE15A+rfc/3bZ7AlMnQfywCkKsfcgMM9ZP+QHtIn0vLeBAFduiFdQ/0DmvtR5LXJ6CPSXe2ZXcFNlTxFbemKrbZPs35XogeS9xeQr+anT6LzoOwEDwZJ7jwhXUnwkTTiDQ2Ja34AAAABB0RVh0TG9kZVBORwAyMDExMDIyMeNZtsEAAAAASUVORK5CYII=" alt="Reset" width=12 height=	12/>

	Reset</div>

	<div class=pico8_el onclick="Module.pico8TogglePaused();">

	<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAPUlEQVR4Ae3doQ0AIAxEUWABLPtPh2WCq26DwFSU/JPNT166QSu/Hg86W9dwLte+diP7AwAAAAAAgD+A+jM2ZAgo84I0PgAAABB0RVh0TG9kZVBORwAyMDExMDIyMeNZtsEAAAAASUVORK5CYII=" alt="Pause" width=12 height=12/>

	Pause</div>
	<div class=pico8_el onclick="Module.requestFullScreen(true, false);">
	<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAaklEQVR4Ae2dsQ1AIQhExfze1v2ns3UCrfgFhmgUUAoGgHscp21wX9BqaZoDojbB96OkDJKNcTN2BHTyYNYmoT2BlPL7BKgcPfHjAVXKKadkHOn9K1r16N0czN6a95N8mnA7Aq2fTZ3Af3UKmCSMazL8HwAAABB0RVh0TG9kZVBORwAyMDExMDIyMeNZtsEAAAAASUVORK5CYII=" alt="Fullscreen" width=12 height=12/>

	Fullscreen</div>
	<div class=pico8_el onclick="Module.pico8ToggleSound();">
	<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAXklEQVR4Ae2doQ4AIQxD4YLH8v9fh+ULhjpxxSwLg2uyapr1JRu1iV5Z+1BGl4+xNpX38SYo2uRvYiT5LwEmt+ocgXVLrhPEgBiw8Q5w7/kueSkK+D2tJO4E/I3GrwkqQCBabEj/4QAAABB0RVh0TG9kZVBORwAyMDExMDIyMeNZtsEAAAAASUVORK5CYII=" alt="Toggle Sound" width=12 height=12/>
	
	Sound</div>
	<div class=pico8_el ><a target="_new" href="http://www.lexaloffle.com/bbs/?cat=7&sub=2">
	<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAlElEQVR4Ae2dMQ5FQBCGh6jcwAkkateg3DiAa+iQUGqVKi95FQfAJRQOoHeBUf8JyQqKjZ1uMzuz2e/LTE3KhyF7kSlgLOykas23f6D+A9Yp84aAOYU15pcJnfji0Il2ID8HzC4y38ZrnfIBGxeRoR3c3EWrACdsV5BOsx7OSRnrOXh4F5HzA6bevwUn8wlz7eCDsQM99B3ks0s/4QAAABB0RVh0TG9kZVBORwAyMDExMDIyMeNZtsEAAAAASUVORK5CYII=" alt="More Carts" width=12 height=12/>

	Carts</a></div>

	<br>	

	</div></center>
	<br><br>

</body></html>
